<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Cat Dungeon — Таблица рекордов</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #101010;
      color: #f5f5f5;
    }
    .page {
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      box-sizing: border-box;
    }
    .card {
      background: #1e1e1e;
      border-radius: 16px;
      padding: 24px 28px;
      box-shadow: 0 0 32px rgba(0,0,0,.7);
      max-width: 640px;
      width: 100%;
    }
    h1 {
      margin: 0 0 4px;
      text-align: center;
      font-size: 26px;
      letter-spacing: .12em;
    }
    .subtitle {
      margin: 0 0 18px;
      text-align: center;
      font-size: 14px;
      color: #b0b0b0;
    }
    .last-result {
      margin-bottom: 18px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255, 152, 0, 0.08);
      border: 1px solid rgba(255, 152, 0, 0.4);
      font-size: 14px;
    }
    .last-result strong {
      color: #ffb74d;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-bottom: 16px;
    }
    th, td {
      padding: 6px 8px;
      text-align: left;
    }
    th {
      border-bottom: 1px solid #444;
      font-weight: 600;
      color: #cccccc;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    tr:nth-child(even) td {
      background: #222222;
    }
    tr.highlight td {
      background: rgba(255, 152, 0, 0.16);
    }
    .empty {
      text-align: center;
      padding: 10px 0;
      color: #999;
      font-size: 14px;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }
    .btn {
      flex: 1;
      padding: 9px 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .btn-main {
      background: #ff9800;
      color: #111;
    }
    .btn-main:hover {
      filter: brightness(1.05);
    }
    .btn-clear {
      background: #333;
      color: #ddd;
    }
    .btn-clear:hover {
      background: #444;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>CAT DUNGEON</h1>
      <p class="subtitle">Таблица рекордов</p>

      <div id="lastResult" class="last-result" style="display:none;"></div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Игрок</th>
            <th>Счёт</th>
            <th>Дата</th>
          </tr>
        </thead>
        <tbody id="recordsBody">
          <!-- строки рекордов сюда -->
        </tbody>
      </table>

      <div class="empty" id="emptyMessage" style="display:none;">
        Пока нет рекордов. Сыграйте партию!
      </div>

      <div class="buttons">
        <button class="btn btn-main" id="btnBack">Назад в меню</button>
        <button class="btn btn-clear" id="btnClear">Очистить рекорды</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'catGameRecords'
    const LAST_KEY = 'catGameLastResult'

    function loadRecords() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY)
        if (!raw) return []
        const arr = JSON.parse(raw)
        if (!Array.isArray(arr)) return []
        return arr
          .filter(r => r && typeof r.score === 'number')
          .sort((a, b) => (b.score || 0) - (a.score || 0))
      } catch (e) {
        console.error('Ошибка чтения рекордов:', e)
        return []
      }
    }

    function loadLastResult() {
      try {
        const raw = localStorage.getItem(LAST_KEY)
        if (!raw) return null
        return JSON.parse(raw)
      } catch {
        return null
      }
    }

    function formatDate(iso) {
      if (!iso) return ''
      try {
        const d = new Date(iso)
        if (Number.isNaN(d.getTime())) return ''
        const dd = String(d.getDate()).padStart(2, '0')
        const mm = String(d.getMonth() + 1).padStart(2, '0')
        const yy = d.getFullYear()
        const hh = String(d.getHours()).padStart(2, '0')
        const min = String(d.getMinutes()).padStart(2, '0')
        return `${dd}.${mm}.${yy} ${hh}:${min}`
      } catch {
        return ''
      }
    }

    function render() {
      const tbody = document.getElementById('recordsBody')
      const lastBlock = document.getElementById('lastResult')
      const empty = document.getElementById('emptyMessage')

      const records = loadRecords()
      const last = loadLastResult()

      if (last) {
        lastBlock.style.display = ''
        lastBlock.innerHTML =
          `<strong>Последняя игра:</strong> ${last.name || 'Игрок'} — ${last.score || 0} очков`
      } else {
        lastBlock.style.display = 'none'
      }

      tbody.innerHTML = ''

      if (!records.length) {
        empty.style.display = ''
        return
      }
      empty.style.display = 'none'

      let highlightIndex = -1
      if (last) {
        highlightIndex = records.findIndex(r =>
          r.name === last.name &&
          r.score === last.score &&
          r.date === last.date
        )
      }

      records.forEach((rec, idx) => {
        const tr = document.createElement('tr')
        if (idx === highlightIndex) {
          tr.classList.add('highlight')
        }

        const tdRank = document.createElement('td')
        tdRank.textContent = String(idx + 1)

        const tdName = document.createElement('td')
        tdName.textContent = rec.name || 'Игрок'

        const tdScore = document.createElement('td')
        tdScore.textContent = String(rec.score || 0)

        const tdDate = document.createElement('td')
        tdDate.textContent = formatDate(rec.date)

        tr.appendChild(tdRank)
        tr.appendChild(tdName)
        tr.appendChild(tdScore)
        tr.appendChild(tdDate)
        tbody.appendChild(tr)
      })
    }

    function setupButtons() {
      const btnBack = document.getElementById('btnBack')
      const btnClear = document.getElementById('btnClear')

      btnBack.addEventListener('click', () => {
        window.location.href = 'login.html'
      })

      btnClear.addEventListener('click', () => {
        if (!confirm('Точно очистить все рекорды?')) return
        try {
          localStorage.removeItem(STORAGE_KEY)
          localStorage.removeItem(LAST_KEY)
        } catch (e) {
          console.error('Не удалось очистить рекорды:', e)
        }
        render()
      })
    }

    document.addEventListener('DOMContentLoaded', () => {
      render()
      setupButtons()
    })
  </script>
</body>
</html>
